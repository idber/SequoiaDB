<!-- ============================================================================
@description:  reliability test
@author:       CSQ 2017-03-06
============================================================================= -->
<project default="main" basedir="../../">       
   <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
         <pathelement location="${basedir}/lib/ant-contrib-1.0b2.jar" />
      </classpath>
   </taskdef>
   <taskdef name="staf" classname="com.ibm.staf.ant.taskdef.STAF" >
      <classpath>
         <pathelement location="${basedir}/lib/STAFAnt.jar" />
      </classpath>
   </taskdef>
   
   <import file="${basedir}/src/test/compile_testcase.xml" />
   <import file="${basedir}/src/test/distribute_testcase.xml" />
   <property file="${basedir}/src/conf/test.conf" />
   
   <target name="main">
      <antcallback target="check_parameter" return="DEPLOY_MODE"/>
      <propertycopy name="testhost_list" from="${plat_form}_${TEST_TYPE}_${DEPLOY_MODE}_HOST" /> 
      <property name="case_basedir" location="${WORKSPACE}/sequoiadb/testcase_reliability" />
      <property name="testcase_outdir" location="${WORKSPACE}/tmp" />
      <property name="remote_casedir" location="${CI_WORK_DIR}/testcase" />
      
      <antcall target="ntpdate_time"/>
      
      <if>
         <or>
            <equals arg1="${serial_number}" arg2="1"/>
            <equals arg1="${serial_number}" arg2="3"/>
         </or>
         <then>
            <antcall target="ready_testcase"/>
            
            <antcall target="ready_jdk"/>
            
            <antcall target="prepare_before_testcase"/>
         </then>
      </if>
      
      <antcall target="exec_testcase" />
      
   </target>
   
   <target name="ntpdate_time">
      <hostinfo prefix="host" />
      <for list="${testhost_list}" param="testhost">
         <sequential>
            <staf location="@{testhost}" service="PROCESS"
                  request="START SHELL COMMAND ntpdate 192.168.20.11 WAIT 2m"
                  throwBuildException=""/>
         </sequential>
      </for>
   </target>
   
   <target name="check_parameter">  
      <if>
         <isset property="DEPLOY_MODE"/>
         <else>
            <var name="DEPLOY_MODE" value="G3D3" />
         </else>
      </if>
   </target>
   
   <target name="ready_testcase">      
      <delete dir="${case_basedir}" failonerror="false" />
      <mkdir dir="${case_basedir}"/>
      <copy todir="${case_basedir}">
         <fileset dir="${WORKSPACE}/sequoiadb/testcase"/>
      </copy>
      
      <if>
         <equals arg1="${plat_form}" arg2="PPC" />
         <then>
            <delete dir="${case_basedir}/tdd/mongoc" />
         </then>
      </if>
   </target>
   
   <target name="ready_jdk">

      <staf location="local" service="PROCESS"
            request="START SHELL COMMAND rm -rf ${INSTALL_DIR} WAIT 1m"
            throwBuildException="1"/> 
      <staf location="local" service="PROCESS"
            request="START SHELL COMMAND mkdir ${INSTALL_DIR} WAIT 1m"
            throwBuildException="1"/>  
     
      <hostinfo prefix="host" />
      
      <propertyregex property="firsthost" input="${testhost_list}" regexp=",(.*)" replace="" defaultValue="${testhost_list}"/>
      <staf location="${firsthost}" service="FS"
         request="COPY DIRECTORY ${INSTALL_DIR}/java TODIRECTORY ${INSTALL_DIR}/java TOMACHINE ${host.NAME} RECURSE"
         throwBuildException="1"/>
         
      <staf location="local" service="PROCESS"
            request="START SHELL COMMAND chown -R jenkins:jenkins ${INSTALL_DIR}/java WAIT 1m"
            throwBuildException="1"/>
            
      <property name="remote_chmod_exec" value="chmod a+rwx,u+rwx,g+rwx ${INSTALL_DIR}/java -R"/>
      <staf location="local" service="PROCESS"
            request="START SHELL COMMAND ${remote_chmod_exec} WAIT 1m"
            throwBuildException="1"/>      
   </target>
   
   <target name="prepare_before_testcase">
      
      <hostinfo prefix="host" />

      <!--ready script in remote host-->
      <for list="${testhost_list},${host.NAME}" param="testhost" parallel="false">
         <sequential> 
            <staf location="@{testhost}" service="FS"
                        request="DELETE ENTRY ${CI_WORK_DIR} RECURSE CONFIRM"
                        throwBuildException=""/>
            <staf location="@{testhost}" service="FS"
                        request="CREATE DIRECTORY ${CI_WORK_DIR} FULLPATH"
                        throwBuildException="1"/>
            <staf location="@{testhost}" service="FS"
                        request="CREATE DIRECTORY ${CI_WORK_DIR}/script FULLPATH"
                        throwBuildException="1"/>
            <staf location="local" service="FS"
                  request="COPY DIRECTORY ${basedir} TODIRECTORY ${CI_WORK_DIR}/script TOMACHINE @{testhost} RECURSE"
                  throwBuildException="1"/>
         </sequential>
      </for>
      
      <mkdir dir="${CI_WORK_DIR}/report"/>
      
      <!--mkdir /tmp/ci_reliability for testcase-->
      <for list="${testhost_list}" param="testhost" parallel="false">
         <sequential>
            <staf location="@{testhost}" service="FS"
                  request="DELETE ENTRY ${RELIABILITY_TESTCASE_WORK_DIR} RECURSE CONFIRM"
                  throwBuildException=""/>  
            <staf location="@{testhost}" service="FS"
                  request="CREATE DIRECTORY ${RELIABILITY_TESTCASE_WORK_DIR} FULLPATH"
                  throwBuildException="1"/>  
         </sequential>
      </for>
      
      <mkdir dir="${CI_WORK_DIR}/testcase"/>
      <copy todir="${CI_WORK_DIR}/testcase">
         <fileset dir="${case_basedir}" includes="**/*"/>
      </copy>
      <copy todir="${WORKSPACE}/sequoiadb/misc/ci/src">
         <fileset dir="${case_basedir}/reliability" includes="script/**/*"/>
      </copy>
   </target>

   <target name="exec_testcase">
      
      <property name="report_basedir" value="${CI_WORK_DIR}/report" />
      <if>
         <or>
            <equals arg1="${serial_number}" arg2="1"/>
            <equals arg1="${serial_number}" arg2="3"/>
         </or>
         <then>
            <delete dir="${report_basedir}" failonerror="false"/>
            <mkdir dir="${report_basedir}"/>
            <delete dir="${WORKSPACE}/report" failonerror="false"/>
            <mkdir dir="${WORKSPACE}/report"/>
         </then>
      </if>

      <!--testcase/reliability testng.xml testng_release.xml-->
      <var name="exec_file" value="${basedir}/src/test/exec_testcase/exec_java_case.xml"/>
      
      <ant antfile="${exec_file}" inheritAll="false">
         <property name="TEST_TYPE" value="${TEST_TYPE}"/>
         <property name="testcase_type" value="reliability"/>
         <property name="testcase_dir" value="${CI_WORK_DIR}/testcase/reliability/java"/>
         <property name="report_dir" value="${report_basedir}/reliability" />
         <property name="serial_number" value="${serial_number}"/>
         <property name="testhost_list" value="${testhost_list}"/>
      </ant>
      <hostinfo prefix="host" />
      <staf location="local" service="FS"
            request="COPY DIRECTORY ${report_basedir} TODIRECTORY ${WORKSPACE}/report TOMACHINE ${host.NAME} RECURSE"
            throwBuildException="1"/>
      
   </target>
   
</project>