<!-- ============================================================================
@description:  exec js testcase
@parameter:    TEST_TYPE              eg: CONFIGURETEST
               testcase_type          eg: tdd_c
               testcase_dir           eg: /tmp/ci/testcase/tdd/c
               report_dir             egï¼š/tmp/ci/report/tdd_c
@author:       Ting YU 2016-11-1
============================================================================= -->

<project default="exec_js_testcase" basedir="../../../">     
   <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
         <pathelement location="${basedir}/lib/ant-contrib-1.0b2.jar" />
      </classpath>
   </taskdef>
   <import file="${basedir}/src/test/exec_testcase/common.xml" />
   
   <target name="exec_js_testcase">
      <property file="${basedir}/src/conf/test.conf" /> 
      
      <if>
         <isset property="BREAK_ON_FAILURE"/>
         <else>
            <var name="BREAK_ON_FAILURE" value="false"/>
         </else>
      </if>
      <prefix resultproperty="prefix"/>
      <detectenv detectfile="${testcase_dir}/common/all_clean.js" prefix="${prefix}" envisok="envrc"/>
      <detectenv detectfile="${testcase_dir}/common/all_prepare.js" prefix="${prefix}" envisok="envrc" output="screen_output"/> 
      <if>
         <equals arg1="${envrc}" arg2="0" />
         <then>
            <copy file="${basedir}/src/test/exec_testcase/report_succ_temple.xml" tofile="${report_dir}/all_prepare.xml"/>
         </then>
         <else>
            <copy file="${basedir}/src/test/exec_testcase/report_fail_temple.xml" tofile="${report_dir}/all_prepare.xml"/>
         </else>
      </if>
      <replace file="${report_dir}/all_prepare.xml" token='TESTCASE_TYPE' value='${testcase_type}'/>
      <replace file="${report_dir}/all_prepare.xml" token='TESTSUIT_NAME' value='all_prepare'/>
      <replace file="${report_dir}/all_prepare.xml" token='TESTCASE_NAME' value='all_prepare'/>
      <if>
         <equals arg1="${envrc}" arg2="0" />
         <else>
            <hostinfo prefix="host" />
            <var name="backup_reltdir" value="${TEST_TYPE}_${DEPLOY_MODE}_${BUILD_NUMBER}.tar.gz"/>
            <var name="download_url" value="&#10;DOWNLOAD DIAGLOG :&#10;http://192.168.30.185:8081/${backup_reltdir}&#10;" />
            <var name="ms0" value="EXECUTE HOST: ${host.NAME}/${host.ADDR4}&#10;&#10;"/>
            <var name="ms1" value="RETURN CODE: ${envrc}&#10;"/>
            <var name="ms2" value="OUTPUT MESSAGE:&#10;${screen_output}&#10;&#10;"/>
            <replace file="${report_dir}/all_prepare.xml" token="ERROR_MESSAGE" value="${ms0}${ms1}${ms2}"/>
         </else>
      </if>
      <if>
         <equals arg1="${envrc}" arg2="0" />
         <then>
            <processonesuit suitfullname="${testcase_dir}"
                            prefix="${prefix}"
                            reportdir="${report_dir}"/>
            <detectenv detectfile="${testcase_dir}/common/all_clean.js" prefix="${prefix}" envisok="envrc"/> 
         </then>
      </if>
   </target>

   <macrodef name="detectenv">
      <attribute name="detectfile" />
      <attribute name="prefix" />
      <attribute name="output" default="screen_output"/>
      <attribute name="envisok" />
      <sequential>
         <var name="jsdir" unset="true"/>
         <dirname property="jsdir" file="@{detectfile}" />
         
         <var name="func_exist" unset="true"/>                             
         <available property="func_exist" file="${jsdir}/func.js" /> 
         <if>
            <isset property="func_exist" />
            <then>               
               <var name="func_option" value="${jsdir}/func.js," />
            </then>
            <else>
               <var name="func_option" value="" />
            </else>
         </if>          
                 
         <var name="cmd1" value="-f &quot;${func_option}@{detectfile}&quot;" />
         <var name="cmd2" value="-e &quot;var CHANGEDPREFIX='@{prefix}';var COORDSVCNAME='${SVCNAME}';var COORDHOSTNAME='localhost'&quot;" />
         <echo message="exec cmd: ${INSTALL_DIR}/bin/sdb ${cmd1} ${cmd2}"/>      
         <var name="@{output}" unset="true"/>
         <var name="@{envisok}" unset="true"/>
         <exec executable="${INSTALL_DIR}/bin/sdb"  
               outputproperty="@{output}" 
               resultproperty="@{envisok}"
               failonerror="false">
            <arg line="${cmd1} ${cmd2}" />
         </exec>
         <echo message="${@{output}}" />       
      </sequential>
   </macrodef>
   
   <macrodef name="processonesuit">
      <attribute name="suitfullname"/>
      <attribute name="reportdir"/>
      <attribute name="prefix"/>
      <sequential>
      <for param="casefullname">
         <path>
            <fileset dir="@{suitfullname}" includes="*.js" excludes="common,testcase.conf"/>
         </path>
         <sequential> 
            <processonecase reportdir="@{reportdir}" 
                            pcsrc="processrc" 
                            prefix="@{prefix}"
                            casefullname="@{casefullname}"/>
         </sequential>
      </for>
      
      </sequential>
   </macrodef>

   <macrodef name="processonecase">
      <attribute name="pcsrc"/>
      <attribute name="reportdir"/>
      <attribute name="prefix"/>
      <attribute name="casefullname" />   
      <sequential>
         <var name="testcase_name" unset="true" />
         <basename property="testcase_name" file="@{casefullname}" suffix=".js"/>
         <detectenv detectfile="${testcase_dir}/common/before_usecase.js" prefix="${prefix}" 
                    output="before_output" envisok="envrc"/>
         <runonecase jsfile="@{casefullname}"
                     prefix="${prefix}" 
                     beforeoutput="${before_output}" 
                     report="@{reportdir}/${testcase_name}.xml"
                     rc="caserc" />
         <detectenv detectfile="${testcase_dir}/common/after_usecase.js" prefix="${prefix}" envisok="envrc"/>  
      </sequential>
   </macrodef>
   
   <macrodef name="runonecase">
      <attribute name="jsfile" />
      <attribute name="prefix" />
      <attribute name="report" />
      <attribute name="beforeoutput" />
      <attribute name="rc"/>
      <sequential>
         <!--before-->
         <var name="jsdir" unset="true"/>
         <var name="casename" unset="true"/>
         <var name="suitname" unset="true"/>
         <dirname property="jsdir" file="@{jsfile}" />
         <basename property="casename" file="@{jsfile}" suffix=".js"/>
         <basename property="suitname" file="${jsdir}" />
         
         <var name="begin_time" unset="true"/>
         <tstamp>
            <format property="begin_time" pattern="yyyy-MM-dd_HH:mm:ss" />
         </tstamp>       
         <script language="javascript">
            project.setProperty('start_ms', new Date().getTime());
         </script>

         <markinlog casename="@{jsfile}" marktype="begin"/>
         
         <!--execute-->
         <var name="func_exist" unset="true"/>
         <available property="func_exist" file="${jsdir}/common/func.js" />       
         <if>
            <isset property="func_exist" />
            <then>
               <var name="func_option" value="${jsdir}/common/func.js," />
            </then>
            <else>                             
               <var name="func_option" value="" />             
            </else>
         </if>
         
         <var name="commlib_exist" unset="true"/>
         <available property="commlib_exist" file="${jsdir}/commlib.js" />
         <if>
            <isset property="commlib_exist" />
            <then>               
               <var name="commlib_option" value="${jsdir}/commlib.js," />
            </then>
            <else>              
               <var name="commlib_option" value="" />
            </else>
         </if>
         
         <var name="cmd1" value="-f &quot;${func_option}${commlib_option}@{jsfile}&quot;" />
         <var name="cmd2" value="-e &quot;var CHANGEDPREFIX='${prefix}';var COORDSVCNAME='${SVCNAME}';var COORDHOSTNAME='localhost';var TESTCASEDIR='${jsdir}';&quot;" />
         <echo message="exec cmd: ${INSTALL_DIR}/bin/sdb ${cmd1} ${cmd2}"/>      
         
         <var name="screen_output" unset="true"/>
         <var name="@{rc}" unset="true"/>
         <exec executable="${INSTALL_DIR}/bin/sdb" 
               dir="${jsdir}" 
               outputproperty="screen_output" 
               resultproperty="@{rc}"
               failonerror="false">
            <arg line="${cmd1} ${cmd2}" />
         </exec>
         <echo message="${screen_output}" />
         
         <!--after-->
         <markinlog casename="@{jsfile}" marktype="end"/>
         
         <var name="end_time" unset="true"/>
         <tstamp>
            <format property="end_time" pattern="yyyy-MM-dd_HH:mm:ss" />
         </tstamp>
         <script language="javascript">
            project.setProperty('total_time', ( new Date().getTime() - start_ms ) / 1000 );
         </script>
         <echo message="the result code is ${@{rc}}, begin at ${begin_time}, end at ${end_time}" />
         
         <!--generate report-->
         <if>
            <equals arg1="${@{rc}}" arg2="0" />
            <then>
               <copy file="${basedir}/src/test/exec_testcase/report_succ_temple.xml" tofile="@{report}"/>
            </then>
            <else>
               <copy file="${basedir}/src/test/exec_testcase/report_fail_temple.xml" tofile="@{report}"/>            
            </else>
         </if>
         
         <replace file="@{report}" token='TESTCASE_TYPE' value='${testcase_type}'/>
         <replace file="@{report}" token='TESTSUIT_NAME' value='${suitname}'/>
         <replace file="@{report}" token='TESTCASE_NAME' value='${casename}'/>
         <replace file="@{report}" token='0000' value='${total_time}'/>
         
         
         <propertycopy name="testhost_list" from="${plat_form}_${TEST_TYPE}_${DEPLOY_MODE}_HOST" />
         <var name="cluster_host_info" value=""/>
         <for list="${testhost_list}" param="testhost">
            <sequential>
               <hostinfo prefix="prefix@{testhost}" host="@{testhost}"/>
               <var name="cluster_host_info" value="${cluster_host_info} @{testhost}/${prefix@{testhost}.ADDR4}"/>
            </sequential>
         </for>
         
         <if>
            <equals arg1="${@{rc}}" arg2="0" />            
            <else>
               <hostinfo prefix="host" />
               <var name="backup_reltdir" value="${TEST_TYPE}_${DEPLOY_MODE}_${BUILD_NUMBER}.tar.gz"/>
               <var name="download_url" value="&#10;DOWNLOAD DIAGLOG :&#10;http://192.168.30.185:8081/${backup_reltdir}&#10;" />
               <var name="ms0" value="EXECUTE HOST: ${host.NAME}/${host.ADDR4}&#10;&#10;"/>
               <var name="ms1" value="CLUSTER HOST:${cluster_host_info}&#10;&#10;"/>
               <var name="ms2" value="EXECUTE CMD:&#10;${INSTALL_DIR}/bin/sdb ${cmd1} ${cmd2}&#10;"/>
               <var name="ms3" value="RETURN CODE: ${@{rc}}&#10;"/>
               <var name="ms4" value="OUTPUT MESSAGE:&#10;${screen_output}&#10;&#10;"/>
               <var name="ms5" value="EXCUTE before_usecase.js OUTPUT MESSAGE:&#10;@{beforeoutput}&#10;"/>
               <replace file="@{report}" token="ERROR_MESSAGE" value="${ms0}${ms1}${ms2}${ms3}${ms4}${ms5}${download_url}"/>
            </else>
         </if>
      </sequential>
   </macrodef>
</project>