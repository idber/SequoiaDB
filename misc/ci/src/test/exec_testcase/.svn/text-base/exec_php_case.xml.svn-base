<!-- ============================================================================
@description:  exec php testcase
@parameter:    TEST_TYPE              eg: CONFIGURETEST
               testcase_type          eg: tdd_c
               testcase_dir           eg: /tmp/ci/testcase/tdd/c
               report_dir             egï¼š/tmp/ci/report/tdd_c
@author:       Ting YU 2016-10-31
============================================================================= -->

<project default="exec_php_testcase" basedir="../../../">     
   <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
         <pathelement location="${basedir}/lib/ant-contrib-1.0b2.jar" />
      </classpath>
   </taskdef>
   <import file="${basedir}/src/test/exec_testcase/common.xml" />
   
   <target name="exec_php_testcase">
      <property file="${basedir}/src/conf/test.conf" />
      
      <!--init-->
      <if>
         <available file="${testcase_dir}/phpunit.xml"/>
         <then>
            <prefix resultproperty="prefix"/>
            <replaceregexp file="${testcase_dir}/phpunit.xml"
                           match='"CHANGEDPREFIX" value="(.*)"' 
                           replace='"CHANGEDPREFIX" value="${prefix}"' 
                           flags="g" 
                           byline="true" 
                           encoding="utf-8"/>
         </then>
      </if>
      <if>
         <isset property="BREAK_ON_FAILURE"/>
         <else>
            <var name="BREAK_ON_FAILURE" value="false"/>
         </else>
      </if>
      <delemptysuit testcasedir="${testcase_dir}" />
      
      <!--execute-->
      <var name="processrc" value="0"/>
      <execallcase phpversion="php5dot4" testcasedir="${testcase_dir}" reportdir="${report_dir}"/>
      <execallcase phpversion="php5dot5" testcasedir="${testcase_dir}" reportdir="${report_dir}"/>
      <execallcase phpversion="php5dot6" testcasedir="${testcase_dir}" reportdir="${report_dir}"/>
      <execallcase phpversion="php7dot0" testcasedir="${testcase_dir}" reportdir="${report_dir}"/>
      <execallcase phpversion="php7dot1" testcasedir="${testcase_dir}" reportdir="${report_dir}"/>
   </target>   
   
   <macrodef name="delemptysuit">       
      <attribute name="testcasedir"/>
      <sequential>
         <for param="testsuit">
            <path>
               <dirset dir="@{testcasedir}" includes="*" excludes="tools"/>
            </path>
            <sequential>  
               <var name="testcase_num" unset="true"/>
               <resourcecount property="testcase_num">
                  <fileset dir="@{testsuit}/" includes="*.php" />
               </resourcecount>
               
               <if>
                  <equals arg1="${testcase_num}" arg2="0"/>
                  <then>
                     <delete dir="@{testsuit}" failonerror="true"/>
                  </then>
               </if>
            </sequential>
         </for>
      </sequential>
   </macrodef>
   
   <macrodef name="execallcase">       
      <attribute name="phpversion"/>
      <attribute name="testcasedir"/>
      <attribute name="reportdir"/>
      <sequential>
      <for param="testsuit">
         <path>
            <dirset dir="@{testcasedir}" includes="*" excludes="tools"/>
         </path>
         <sequential>

            <var name="is_continue_exec" unset="true"/>
            <condition property="is_continue_exec" value="true" else="false">
               <or>
                  <equals arg1="${BREAK_ON_FAILURE}" arg2="false"/>
                  <and>
                     <equals arg1="${BREAK_ON_FAILURE}" arg2="true"/>
                     <equals arg1="${processrc}" arg2="0"/>
                  </and>
               </or>
            </condition>
            
            <if>
               <equals arg1="${is_continue_exec}" arg2="true"/>
               <then>
                  <echo>${line.separator}***********begin to execute php testcases by @{phpversion}***********</echo>
                  <processonesuit reportdir="@{reportdir}" 
                                  pcsrc="processrc" 
                                  testsuit="@{testsuit}"
                                  phpversion="@{phpversion}"/>
               </then>
            </if>
            <if>
               <equals arg1="${is_continue_exec}" arg2="false"/>
               <then>
                  <touch file="@{reportdir}/.TESTCASE_FAIL"/>
               </then>
            </if>
         </sequential>
      </for>
      
      </sequential>
   </macrodef>      

   <macrodef name="processonesuit">
      <attribute name="pcsrc"/>
      <attribute name="reportdir"/>
      <attribute name="testsuit" /> 
      <attribute name="phpversion"/>      
      <sequential>
         <var name="testsuit_name" unset="true" />
         <basename property="testsuit_name" file="@{testsuit}"/>
         <var name="testsuit_name" value="${testsuit_name}_@{phpversion}"/>
         
         <detectenv envisok="envrc" casetype="${testcase_type}" casename="${testsuit_name}"
                    rptfullname="@{reportdir}/before_${testcase_type}_${testsuit_name}.xml" />
         
         <if>
            <and>
               <equals arg1="${BREAK_ON_FAILURE}" arg2="true"/>
               <not>
                  <equals arg1="${envrc}" arg2="0"/>
               </not>
            </and>
            <else>
               <changeconf mode="before" conffullname="@{testsuit}/node.conf" 
                           rc="conf_rc1" casetype="${testcase_type}" 
                           rptfullname="@{reportdir}/configure_before_${testsuit_name}.xml" />

               <if>
                  <equals arg1="${conf_rc1}" arg2="0" />
                  <then>                                  
                     <hostinfo prefix="host" />
                     <runonesuit  suitfullname="@{testsuit}" 
                                  suitname="${testsuit_name}"
                                  phpver="@{phpversion}" 
                                  report="@{reportdir}/${testsuit_name}_${host.NAME}.xml"
                                  casetype="${testcase_type}" 
                                  rc="caserc"/>
                  </then>
               </if>

               <changeconf mode="after" conffullname="@{testsuit}/node.conf.ini" 
                           rc="conf_rc2" casetype="${testcase_type}" 
                           rptfullname="@{reportdir}/configure_after_${testsuit_name}.xml"/>
            
            </else>
         </if>
         
         <var name="@{pcsrc}" unset="true"/>
         <condition property="@{pcsrc}" value="0" else="1">
            <and>
               <equals arg1="${envrc}" arg2="0"/>
               <equals arg1="${caserc}" arg2="0"/>
            </and>
         </condition>
      </sequential>
   </macrodef>
   
   <macrodef name="runonesuit">
      <attribute name="phpver"/>
      <attribute name="suitfullname" />
      <attribute name="suitname" />
      <attribute name="casetype" />
      <attribute name="report" />
      <attribute name="rc" />
      <sequential>
         <!--before-->
         <var name="begin_time" unset="true"/>
         <tstamp>
            <format property="begin_time" pattern="yyyy-MM-dd_HH:mm:ss" />
         </tstamp>       

         <markinlog casename="@{suitfullname}_@{phpver}" marktype="begin"/>
         
         <!--execute-->
         <if>
            <equals arg1="@{phpver}" arg2="php5dot4" />
            <then>
               <var name="php_exe" value="${INSTALL_DIR}/tools/server/php/bin/php-bin"/>
               <var name="ini_cmd" value=""/>
               <var name="libxml2_dir" value=""/>
            </then>
         </if>
         <if>
            <equals arg1="@{phpver}" arg2="php5dot5" />
            <then>
               <var name="php_exe" value="/opt/php_5.5.0/bin/php"/>
               <var name="ini_cmd" value="-c /opt/php_5.5.0/lib/php.ini"/>
               <var name="libxml2_dir" value="/opt/php_5.5.0/libxml2/lib"/>
            </then>
         </if>
         <if>
            <equals arg1="@{phpver}" arg2="php5dot6" />
            <then>
               <var name="php_exe" value="/opt/php_5.6.0/bin/php"/>
               <var name="ini_cmd" value="-c /opt/php_5.6.0/lib/php.ini"/>
               <var name="libxml2_dir" value="/opt/php_5.6.0/libxml2/lib"/>
            </then>
         </if>
         <if>
            <equals arg1="@{phpver}" arg2="php7dot0" />
            <then>
               <var name="php_exe" value="/opt/php_7.0.0/bin/php"/>
               <var name="ini_cmd" value="-c /opt/php_7.0.0/lib/php.ini"/>
               <var name="libxml2_dir" value="/opt/php_7.0.0/libxml2/lib"/>
            </then>
         </if>
         <if>
            <equals arg1="@{phpver}" arg2="php7dot1" />
            <then>
               <var name="php_exe" value="/opt/php_7.1.11/bin/php"/>
               <var name="ini_cmd" value="-c /opt/php_7.1.11/lib/php.ini"/>
               <var name="libxml2_dir" value="/opt/php_7.1.11/libxml2/lib"/>
            </then>
         </if>
         
         <if>
            <available file="@{suitfullname}/../phpunit.xml"/>
            <then>
               <var name="conf_cmd" value="-c @{suitfullname}/../phpunit.xml"/>
            </then>
            <else>
               <var name="conf_cmd" value=""/>
            </else>
         </if>
            
         <var name="phpunit" value="@{suitfullname}/../tools/phpunit.phar"/>
         <var name="cmd" value="${ini_cmd} ${phpunit} ${conf_cmd} --log-junit @{report} @{suitfullname}"/>
         <echo message="exec cmd: ${php_exe} ${cmd}"/>
         <echo message="exec dir: @{suitfullname}"/>
         <echo>export LD_LIBRARY_PATH=${libxml2_dir}:${LD_LIBRARY_PATH}</echo>
         
         <var name="screen_output" unset="true"/> 
         <var name="@{rc}" unset="true"/> 
         <exec executable="${php_exe}" 
               dir="@{suitfullname}" 
               timeout="3600000" 
               outputproperty="screen_output"
               resultproperty="@{rc}" 
               failonerror="false" >
            <arg line="${cmd}"/>
            <env key="LD_LIBRARY_PATH" path="${libxml2_dir}:${LD_LIBRARY_PATH}" /> 
         </exec>
         <echo message="${screen_output}" />
         
         <!--after-->
         <markinlog casename="@{suitfullname}_@{phpver}" marktype="end"/>
         
         <var name="end_time" unset="true"/>
         <tstamp>
            <format property="end_time" pattern="yyyy-MM-dd_HH:mm:ss" />
         </tstamp>
         <echo message="begin at ${begin_time}, end at ${end_time}" />
         
         <propertycopy name="testhost_list" from="${plat_form}_${TEST_TYPE}_${DEPLOY_MODE}_HOST" />
         <var name="cluster_host_info" value=""/>
         <for list="${testhost_list}" param="testhost">
            <sequential>
               <hostinfo prefix="prefix@{testhost}" host="@{testhost}"/>
               <var name="cluster_host_info" value="${cluster_host_info} @{testhost}/${prefix@{testhost}.ADDR4}"/>
            </sequential>
         </for>
         
         <!--modify report-->
         <hostinfo prefix="host" />
         <var name="ms1" value="EXECUTE HOST: ${host.NAME}/${host.ADDR4}&#10;&#10;"/>   
         <var name="ms2" value="CLUSTER HOST:${cluster_host_info}&#10;&#10;"/>          
         <replaceregexp file="@{report}" 
                        match='&lt;failure(.*)&gt;' 
                        replace='&lt;failure\1&gt;&#10;${ms1}${ms2}' 
                        flags="g" 
                        byline="true" 
                        encoding="utf-8"/>
         
         <replaceregexp file="@{report}"
                        match='&lt;testcase name="(.*)" class="(.*)" file' 
                        replace='&lt;testcase name="\2.\1" class="\2" file' 
                        flags="g" 
                        byline="true" 
                        encoding="utf-8"/>            
         <replaceregexp file="@{report}"
                        match='&lt;testcase n' 
                        replace='&lt;testcase classname="@{casetype}.@{suitname}" n' 
                        flags="g" 
                        byline="true" 
                        encoding="utf-8"/>
         <var name="backup_reltdir" value="${TEST_TYPE}_${DEPLOY_MODE}_${BUILD_NUMBER}.tar.gz"/>
         <var name="download_url" value="&#10;DOWNLOAD DIAGLOG :&#10;http://192.168.30.185:8081/${backup_reltdir}&#10;" />
         <replaceregexp file="@{report}" 
                        match='&lt;\/failure&gt;' 
                        replace='${download_url}&lt;\/failure&gt;'  
                        flags="g" 
                        byline="true" 
                        encoding="utf-8"/>
      </sequential>
   </macrodef>

</project>