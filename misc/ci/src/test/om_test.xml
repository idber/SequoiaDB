<!-- ============================================================================
@description:  daily build, except largedata, sync, reliable, configure test
               WORKSPACE, from jenkins build-in variable
               TEST_TYPE, from jenkins configure page
               TESTCASE_TYPE, from jenkins user page
               plat_form, from buil.xml
@author:       CSQ 2018-07-04
============================================================================= -->

<project default="main" basedir="../../">       
   <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
         <pathelement location="${basedir}/lib/ant-contrib-1.0b2.jar" />
      </classpath>
   </taskdef>
   <taskdef name="staf" classname="com.ibm.staf.ant.taskdef.STAF" >
      <classpath>
         <pathelement location="${basedir}/lib/STAFAnt.jar" />
      </classpath>
   </taskdef>

   <property file="${basedir}/src/conf/test.conf" /> 
   
   <target name="main">     
      <antcallback target="check_parameter" return="TESTCASE_TYPE, DEPLOY_MODE"/>
      
      <propertycopy name="testhost_list" from="${plat_form}_${TEST_TYPE}_${DEPLOY_MODE}_HOST" />          
      <property name="testcase_outdir" location="${WORKSPACE}/tmp" />
      <property name="remote_casedir" location="${CI_WORK_DIR}/testcase" />
      
      <antcall target="ready_testcase"/>
      
      <antcall target="execute_testcase" />
      
   </target>

   <target name="check_parameter">  
      <if>
         <isset property="TESTCASE_TYPE"/>
         <else>           
            <var name="TESTCASE_TYPE" value="tdd_c,tdd_cpp,tdd_php,driver_python,tdd_mongoc,
                                             story_java,story_js,
                                             sdv_java,sdv_js,
                                             driver_c,driver_cpp,driver_java,driver_php,om" />
         </else>
      </if>
      <if>
         <isset property="DEPLOY_MODE"/>
         <else>
            <var name="DEPLOY_MODE" value="G3D3" />
         </else>
      </if>
   </target>
       
   <target name="ready_testcase">      
      <delete dir="${remote_casedir}" failonerror="false" />
      <mkdir dir="${remote_casedir}"/>
      <copy todir="${remote_casedir}">
         <fileset dir="${WORKSPACE}/sequoiadb/testcase" includes="om/**/*"/>
      </copy>
   </target>

   <target name="execute_testcase">
      <var name="testscript_dir" value="${CI_WORK_DIR}/script/src/test" />     
      <var name="testscript_log" value="${testscript_dir}/om_test.log" />
      <hostinfo prefix="host" />
      <!--ready in remote host-->         
      <staf location="local" service="FS"
            request="COPY DIRECTORY ${basedir} TODIRECTORY ${CI_WORK_DIR}/script TOMACHINE ${host.NAME} RECURSE"
            throwBuildException="1"/>
      <staf location="local" service="FS"
            request="DELETE ENTRY ${testscript_log} CONFIRM"/>
      
      <!--execute testcase in remote host-->
      <var name="test_remote_cmd" value="ant -f ${testscript_dir}/om_test.xml exec_remote_testcase -DTEST_TYPE=${TEST_TYPE} -Dplat_form=${plat_form} -DDEPLOY_MODE=${DEPLOY_MODE} -DBUILD_NUMBER=${BUILD_NUMBER}" />
                  
      <staf location="local" service="PROCESS"
            resultPrefix="remote_exec"
            request="START SHELL COMMAND ${test_remote_cmd} STDOUTAPPEND ${testscript_log} STDERRTOSTDOUT WAIT"
            throwBuildException="1"/>
      <staf location="local" service="FS"
            request="GET FILE ${testscript_log} TEXT"
            throwBuildException="1"/>
      
      <propertyregex property="remote_exec_rc" input="${remote_exec.result}" regexp="Return\ Code:\ (.*)\n" select="\1"/>      
      <if>
         <equals arg1="${remote_exec_rc}" arg2="0" />
         <else>
            <fail message="exec: ${test_remote_cmd}, in host: local, return code: ${remote_exec_rc}"/>
         </else>
      </if>

      <!--send report to control host-->
      <delete dir="${WORKSPACE}/report"/>
      <staf location="local" service="FS"
            request="COPY DIRECTORY ${CI_WORK_DIR}/report TODIRECTORY ${WORKSPACE}/report TOMACHINE ${host.NAME} RECURSE"
            throwBuildException="1"/>           

   </target>
   
   <target name="exec_remote_testcase">
      <property name="report_basedir" value="${CI_WORK_DIR}/report" />
      <delete dir="${report_basedir}"/>
      <mkdir dir="${report_basedir}"/>
      
      <mkdir dir="${CI_WORK_DIR}/testcase"/>
      <for param="casetype">
         <path>
            <dirset dir="${CI_WORK_DIR}/testcase" includes="*" excludes="tools"/>
         </path>
         <sequential>
            <for param="casesubtype">
               <path>
                  <dirset dir="@{casetype}" includes="js"/>
               </path>
               <sequential>
                  <var name="testcase_totaltype" unset="true"/>
                  <basename property="testcase_totaltype" file="@{casetype}"/>
                  <var name="testcase_subtype" unset="true"/>
                  <basename property="testcase_subtype" file="@{casesubtype}"/>
                  <var name="testcase_type" value="${testcase_totaltype}_${testcase_subtype}"/>
                  
                  
                  <switch value="${testcase_type}">
                     
                     <case value="om_js">
                        <var name="exec_file" value="${basedir}/src/test/exec_testcase/exec_om_case.xml"/>
                     </case>
                     
                     <default>
                     </default>
                 
                  </switch>
                  
                  <ant antfile="${exec_file}" inheritAll="false">
                     <property name="TEST_TYPE" value="${TEST_TYPE}"/>
                     <property name="testcase_type" value="${testcase_type}"/>
                     <property name="testcase_dir" value="@{casesubtype}"/>
                     <property name="report_dir" value="${report_basedir}/${testcase_type}" />
                     <property name="plat_form" value="${plat_form}"/>
                     <property name="DEPLOY_MODE" value="${DEPLOY_MODE}"/>
                     <property name="BUILD_NUMBER" value="${BUILD_NUMBER}"/>
                     
                  </ant>
               </sequential>
            </for>           
         </sequential>
      </for>

   </target>

</project>