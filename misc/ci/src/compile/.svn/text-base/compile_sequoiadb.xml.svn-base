<project default="main" basedir="../../">
   <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
         <pathelement location="${basedir}/lib/ant-contrib-1.0b2.jar" />
      </classpath>
   </taskdef>
   <taskdef name="staf" classname="com.ibm.staf.ant.taskdef.STAF" >
      <classpath>
         <pathelement location="${basedir}/lib/STAFAnt.jar" />
      </classpath>
   </taskdef>
   <property file="${basedir}/src/conf/test.conf" /> 
   
   <target name="main">    
      <property name="srccode_dir" location="${WORKSPACE}/sequoiadb" />
      <property name="release_dir" location="${WORKSPACE}/release" />    

      <antcallback target="check_parameter" return="cmd_debug, cmd_etp, SPARK_VERSION, SCALA_VERSION, BIN_PACKAGE, COVERAGE, cmd_cov"/>
      
      <delete dir="${release_dir}" failonerror="false"/>
      <mkdir dir="${release_dir}"/>
      
      <dbversion srccodedir="${srccode_dir}" version="sequoiadb_version"/>
      <getplatform resultProperty="platform" />
      
      <antcall target="compile_src"/>   
      <antcall target="compile_java_driver"/>
      <antcall target="compile_php_driver"/>
      <antcall target="compile_python_driver"/>
      <antcall target="compile_pg_connector"/>
      <antcall target="compile_hive_connector"/>
      <antcall target="compile_hadoop_connector"/>
      <antcall target="compile_spark_connector"/>
      <antcall target="compile_postgresql_plugin"/>
      <antcall target="compile_sequoias3"/>
      <antcall target="build_driver_package"/>
      <if>
         <equals arg1="${IS_INCREMENTAL_COMPILE}" arg2="true"/>
         <then>
            <antcall target="tar_commit_tool_package"/>
         </then>
         <else>
            <antcall target="copy_package_file"/>
            <antcall target="build_run_package"/>
            <antcall target="build_bin_package"/>
            <antcall target="build_tar_package"/>
            <antcall target="build_cov_package"/>
         </else>
      </if>
   </target>

   <target name="check_parameter">  
      <if>
         <isset property="IS_DEBUG"/>
         <else>           
            <var name="IS_DEBUG" value="true" />
         </else>
      </if>
      <if>
         <equals arg1="${IS_DEBUG}" arg2="true" />
         <then>          
            <var name="cmd_debug" value="--dd" />           
         </then>
         <else>
            <var name="cmd_debug" value="" />
         </else>
      </if>
      
      <if>
         <isset property="IS_ENTERPRISE"/>
         <else>
            <var name="IS_ENTERPRISE" value="true" />
         </else>
      </if>
      <if>
         <equals arg1="${IS_ENTERPRISE}" arg2="true" />
         <then>          
            <var name="cmd_etp" value="--enterprise" />           
         </then>
         <else>
            <var name="cmd_etp" value="" />
         </else>
      </if>
      
      <if>
         <isset property="SPARK_VERSION"/>
         <else>           
            <var name="SPARK_VERSION" value="2.0.0" />
         </else>
      </if>
  
      <if>
         <isset property="SCALA_VERSION"/>
         <else>           
            <var name="SCALA_VERSION" value="2.11" />
         </else>
      </if>
      
      <if>
         <isset property="BIN_PACKAGE"/>
         <else>           
            <var name="BIN_PACKAGE" value="false" />
         </else>
      </if>

      <if>
         <isset property="UNPACK_DRIVER"/>
         <else>           
            <var name="UNPACK_DRIVER" value="false" />
         </else>
      </if>  

      <if>
         <isset property="COVERAGE"/>
         <else>           
            <var name="COVERAGE" value="false" />
         </else>
      </if>
      <if>
         <equals arg1="${IS_DEBUG}" arg2="false" />
         <then>
            <var name="COVERAGE" unset="true" />
            <var name="COVERAGE" value="false" />
         </then>
      </if>
      <if>
         <equals arg1="${COVERAGE}" arg2="true" />
         <then>          
            <var name="cmd_cov" value="--cov" />           
         </then>
         <else>
            <var name="cmd_cov" value="" />
         </else>
      </if>
   </target>
       
   <target name="compile_src">
      <if>
         <equals arg1="${IS_INCREMENTAL_COMPILE}" arg2="true"/>
         <else>
            <delete dir="${srccode_dir}/bin"  failonerror="false" />
            <delete dir="${srccode_dir}/build" failonerror="false" />
         </else>
      </if>
      
      <var name="cmd" value="${cmd_debug} ${cmd_etp} ${cmd_cov} --all -j 4" />
      <echo message="exec cmd: scons ${cmd}" />
      <exec executable="scons" dir="${srccode_dir}" failonerror="true" logError="true">
         <arg line="${cmd}" />
      </exec>
      
      <chmod perm="u+x" file="${srccode_dir}/bin/sequoiadb" />
      <exec executable="bin/sequoiadb" dir="${srccode_dir}" outputproperty="version_output" failonerror="true" logError="true">
         <arg line="--version" />
      </exec>
      <echo file="${release_dir}/sequoiadb.version" message="${version_output}"/>
   </target>
   
   <target name="compile_pg_connector">
      <var name="src_dir" value="${srccode_dir}/driver/postgresql" />
      
      <!--compile--> 
      <exec executable="make" dir="${src_dir}" failonerror="true" logError="true">
         <arg line="clean" />
      </exec>
      <exec executable="make" dir="${src_dir}" failonerror="true" logError="true">
         <arg line="local" />
      </exec>
      <exec executable="make" dir="${src_dir}" failonerror="true" logError="true">
         <arg line="all" />
      </exec>
      
      <!--get svn version--> 
      <var name="fdw_svn" unset="true" />
      <svnversion dir="${src_dir}" version="fdw_svn" />
      
      <!--get edition (judge changed or original) -->
      <exec executable="bash" dir="${src_dir}" outputproperty="fdw_edition">
         <arg value="-c" />
         <arg line="&quot;nm sdb_fdw.so | grep sdbuseownpostgres&quot;" />
      </exec>
      
      <!--change fdw name-->
      <if>
         <equals arg1="${fdw_edition}" arg2="" />
         <then>            
            <property name="fdw_name" value="sdb_fdw.so_${sequoiadb_version}_${fdw_svn}" />
            <move file="${src_dir}/sdb_fdw.so" tofile="${src_dir}/${fdw_name}"/>
            <echo message="fdw is original, fdw new name = ${fdw_name}" />  
         </then>
         <else>             
            <property name="fdw_name" value="sdb_fdw.so_e_${sequoiadb_version}_${fdw_svn}" />
            <move file="${src_dir}/sdb_fdw.so" tofile="${src_dir}/${fdw_name}"/>
            <echo message="fdw is enterprise, fdw new name = ${fdw_name}" />  
         </else>
      </if>
      
      <!--copy to build directory-->
      <delete dir="${src_dir}/build" failonerror="false"/>
      <mkdir dir="${src_dir}/build"/>
      <copy file="${src_dir}/${fdw_name}"       todir="${src_dir}/build" />
      <copy file="${src_dir}/sdb_fdw.control"   todir="${src_dir}/build" />
      <copy file="${src_dir}/sdb_fdw--1.0.sql"  todir="${src_dir}/build" />

   </target>
   
   <target name="compile_java_driver">
      <var name="src_dir" value="${srccode_dir}/driver/java" />
      <if>
         <equals arg1="${IS_DEBUG}" arg2="true"/>
         <then>
            <svnversion dir="${src_dir}" version="fdw_svn" />
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}-r${fdw_svn}"/>
         </then>
         <else>
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}"/>
         </else>
      </if>
      <exec executable="mvn" dir="${srccode_dir}/driver/java" failonerror="true" logError="true">
         <arg line=" ${cmd_mvn} " />
      </exec>
      <exec executable="mvn" dir="${srccode_dir}/driver/java" failonerror="true" logError="true">
         <arg line=" clean package -Drevision=${fdw_svn} -Dmaven.test.skip=true" />
      </exec>
   </target>
   
   <target name="compile_postgresql_plugin">
      <var name="src_dir" value="${srccode_dir}/tools/om_plugins/sequoiasql/source" />
      <if>
         <equals arg1="${IS_DEBUG}" arg2="true"/>
         <then>
            <svnversion dir="${src_dir}" version="fdw_svn" />
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}-r${fdw_svn}"/>
         </then>
         <else>
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}"/>
         </else>
      </if>
      <exec executable="mvn" dir="${srccode_dir}/tools/om_plugins/sequoiasql/source" failonerror="true" logError="true">
         <arg line=" ${cmd_mvn} " />
      </exec>
      <exec executable="mvn" dir="${srccode_dir}/tools/om_plugins/sequoiasql/source" failonerror="true" logError="true">
         <arg line=" clean package -Drevision=${fdw_svn}" />
      </exec>
   </target>
   
   <target name="compile_sequoias3">
      <var name="src_dir" value="${srccode_dir}/SequoiaDB/engine/tools/sequoias3" />
      <if>
         <equals arg1="${IS_DEBUG}" arg2="true"/>
         <then>
            <svnversion dir="${src_dir}" version="fdw_svn" />
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}-r${fdw_svn}"/>
         </then>
         <else>
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}"/>
         </else>
      </if>
      <exec executable="mvn" dir="${srccode_dir}/SequoiaDB/engine/tools/sequoias3" failonerror="true" logError="true">
         <arg line=" ${cmd_mvn} " />
      </exec>
      <exec executable="mvn" dir="${srccode_dir}/SequoiaDB/engine/tools/sequoias3" failonerror="true" logError="true">
         <arg line=" clean package -Drevision=${fdw_svn} -Dmaven.test.skip=true" />
      </exec>
   </target>
   
   <target name="compile_hive_connector">
      <var name="src_dir" value="${srccode_dir}/driver/hadoop/hive" />
      <if>
         <equals arg1="${IS_INCREMENTAL_COMPILE}" arg2="true"/>
         <else>
            <delete dir="${src_dir}/build" failonerror="false"/>
            <delete dir="${src_dir}/build_cdh" failonerror="false"/>
            <delete dir="${src_dir}/build_open_source" failonerror="false"/>
         </else>
      </if>
      <for param="filepath">
         <path>
            <fileset dir="${srccode_dir}/driver/java/target">
               <include name="sequoiadb*.jar"/>
            </fileset>
         </path>
         <sequential>
            <var name="java_dir_path" value="@{filepath}"/>
         </sequential>
      </for>
      
      <property name="open.source.hive_connector.filename" value="hive-sequoiadb-apache.jar" />
      <property name="cdh.hive_connector.filename" value="hive-sequoiadb-cdh-5.0.0-beta-2.jar" />     
      <ant antfile="${src_dir}/build.xml">
         <property name="java.driver.jar" value="${java_dir_path}"/>
         <property name="javac.base.dir" value="${srccode_dir}"/>
         <property name="root.dir" value="${src_dir}"/>
         <property name="open.source.hive_connector.filename" value="${open.source.hive_connector.filename}" />
         <property name="cdh.hive_connector.filename" value="${cdh.hive_connector.filename}" />
      </ant>
      
      <!--copy to build directory-->
      <mkdir dir="${src_dir}/build"/>
      <copy file="${src_dir}/${cdh.hive_connector.filename}"         todir="${src_dir}/build" />
      <copy file="${src_dir}/${open.source.hive_connector.filename}" todir="${src_dir}/build" />
   </target>
   
   <target name="compile_hadoop_connector">
      <var name="src_dir" value="${srccode_dir}/driver/hadoop/hadoop-connector" />
      <for param="filepath">
         <path>
            <fileset dir="${srccode_dir}/driver/java/target">
               <include name="sequoiadb*.jar"/>
            </fileset>
         </path>
         <sequential>
            <var name="java_dir_path" value="@{filepath}"/>
         </sequential>
      </for>
      <ant antfile="${src_dir}/build.xml">
         <property name="hadoop.version" value="1.2" />
         <property name="basedir" value="${src_dir}" />
         <property name="java.driver.jar" value="${java_dir_path}"/>
      </ant>
      <ant antfile="${src_dir}/build.xml">
         <property name="hadoop.version" value="2.2" />
         <property name="basedir" value="${src_dir}" />
         <property name="java.driver.jar" value="${java_dir_path}"/>
      </ant>
      
      <!--copy to build directory-->
      <delete dir="${src_dir}/build" failonerror="false"/>
      <mkdir dir="${src_dir}/build"/>
      <copy todir="${src_dir}/build" >
         <fileset dir="${src_dir}" includes="**/hadoop-connector-*.jar" />
      </copy>
   </target>
   
   <!--target name="compile_spark_connector">
      <var name="src_dir" value="${srccode_dir}/driver/spark" />
      <delete dir="${src_dir}/target" failonerror="false"/>
      
      <ant antfile="${src_dir}/build.xml">
        <property name="SPARK_VERSION" value="${SPARK_VERSION}" />
        <property name="SCALA_VERSION" value="${SCALA_VERSION}" />
        <property name="root.dir" value="${src_dir}" />
        <property name="WORKSPACE" value="${WORKSPACE}" />
      </ant>
   </target-->
   
   <target name="compile_spark_connector">
      <var name="src_dir" value="${srccode_dir}/driver/spark" />
      <if>
         <equals arg1="${IS_DEBUG}" arg2="true"/>
         <then>
            <svnversion dir="${src_dir}" version="fdw_svn" />
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}-r${fdw_svn}"/>
         </then>
         <else>
            <var name="cmd_mvn" value="versions:set -DnewVersion=${sequoiadb_version}"/>
         </else>
      </if>
      <exec executable="mvn" dir="${srccode_dir}/driver/spark" failonerror="true" logError="true">
         <arg line=" ${cmd_mvn} " />
      </exec>
      <exec executable="mvn" dir="${srccode_dir}/driver/spark" failonerror="true" logError="true">
         <arg line=" clean package -Drevision=${fdw_svn}" />
      </exec>
   </target>
   
   <target name="compile_php_driver">
      <property name="php_version_list" value="5.3.3,5.3.8,5.3.10,5.3.15,5.4.6,5.5.0,5.6.0,7.0.0,7.1.11" />
      <var name="src_dir" value="${srccode_dir}/driver/php" />
      
      <delete dir="${src_dir}/release" failonerror="false"/>
      <mkdir dir="${src_dir}/release" />
      <if>
         <equals arg1="${IS_INCREMENTAL_COMPILE}" arg2="true"/>
         <else>
            <delete dir="${src_dir}/build" failonerror="false"/>
         </else>
      </if>
      
      
      <if>
         <equals arg1="${cmd_debug}" arg2="--dd" />
         <then>
            <property name="build_dir" location="${src_dir}/build/dd" />
         </then>
         <else>
            <property name="build_dir" location="${src_dir}/build/normal" />
         </else>
      </if>
            
      <for list="${php_version_list}" param="phpversion">
         <sequential>
            <chmod perm="u+x" file="${srccode_dir}/thirdparty/php/linux/retriConfig.sh" />
            <exec executable="${srccode_dir}/thirdparty/php/linux/retriConfig.sh" failonerror="true" logError="true">
               <arg line="@{phpversion} " />
            </exec>
            <echo>exec cmd: scons ${cmd_debug} --phpversion=@{phpversion}, in dir: ${src_dir}</echo>
            <exec executable="scons" dir="${src_dir}" failonerror="true" logError="true">
               <arg line="${cmd_debug} --phpversion=@{phpversion}" />
            </exec>
            <copy file="${build_dir}/libsdbphp-@{phpversion}.so" todir="${src_dir}/release" />
         </sequential>
      </for>
   </target>

   <target name="compile_python_driver" >
      <var name="src_dir" value="${srccode_dir}/driver/python" />
      
      <delete>
         <fileset dir="${src_dir}" includes="pysequoiadb*.tar.gz" />
      </delete>
      <if>
         <equals arg1="${IS_INCREMENTAL_COMPILE}" arg2="true"/>
         <else>
            <delete dir="${src_dir}/build" failonerror="false" />
         </else>
      </if>
           
      <exec executable="scons" dir="${src_dir}" failonerror="true" logError="true">
         <arg line="${cmd_debug}" />
      </exec>
      <exec executable="scons" dir="${src_dir}" failonerror="true" logError="true">
         <arg line="${cmd_debug} --py3" />
      </exec>
   </target>
   
   <target name="build_driver_package" >
      <property name="release_driver_dir" location="${release_dir}/driver" />
      <delete dir="${release_driver_dir}" failonerror="false"/>
      <mkdir dir="${release_driver_dir}"/>
      
      <mkdir dir="${release_driver_dir}/C#"/>
      <mkdir dir="${release_driver_dir}/C&amp;CPP"/>
      <mkdir dir="${release_driver_dir}/Hadoop"/>
      <mkdir dir="${release_driver_dir}/Java" /> 
      <mkdir dir="${release_driver_dir}/PHP"/>
      <mkdir dir="${release_driver_dir}/Postgresql" />
      <mkdir dir="${release_driver_dir}/Python" />
      <mkdir dir="${release_driver_dir}/Spark" />
      
      <copy file="${srccode_dir}/driver/C#.Net/build/release/sequoiadb.dll" 
            tofile="${release_driver_dir}/C#/sequoiadb.dll" />
      
      <copy todir="${release_driver_dir}/C&amp;CPP">
         <fileset dir="${srccode_dir}/client" includes="include/**/*" />
      </copy>
      <copy todir="${release_driver_dir}/C&amp;CPP">
         <fileset dir="${srccode_dir}/client" includes="lib/*" />
      </copy>

      <copy todir="${release_driver_dir}/Hadoop" >
         <fileset dir="${srccode_dir}/driver/hadoop/hive/build" includes="**/*" />
      </copy>     
      <copy todir="${release_driver_dir}/Hadoop" >
         <fileset dir="${srccode_dir}/driver/hadoop/hadoop-connector/build" includes="**/*" />
      </copy>
      
      <copy todir="${release_driver_dir}/Spark" >
         <fileset dir="${srccode_dir}/driver/spark/target" includes="*.jar" />
      </copy>

      <for param="filepath">
         <path>
            <fileset dir="${srccode_dir}/driver/java/target">
               <include name="sequoiadb*.jar"/>
            </fileset>
         </path>
         <sequential>
            <var name="java_dir_path" value="@{filepath}"/>
         </sequential>
      </for>
      <copy todir="${release_driver_dir}/Java" 
            file="${java_dir_path}" />
            
      <copy todir="${release_driver_dir}/PHP" >
         <fileset dir="${srccode_dir}/driver/php/release" includes="*.so" />
      </copy>
      
      <copy todir="${release_driver_dir}/Postgresql" >
         <fileset dir="${srccode_dir}/driver/postgresql/build" includes="**/*" />
      </copy>     
      <chmod dir="${release_driver_dir}/Postgresql" includes="*sdb_fdw.so*" perm="a+x" />
      
      <copy todir="${release_driver_dir}/Python" >
         <fileset dir="${srccode_dir}/driver/python/" includes="pysequoiadb*py*.tar.gz" />
      </copy>
      
      <tar destfile="${release_dir}/sequoiadb-driver-${sequoiadb_version}-${platform}.tar.gz" 
           longfile="gnu" compression="gzip" 
           basedir="${release_dir}" includes="driver/**/*"/>
                 
      <if>
         <equals arg1="${UNPACK_DRIVER}" arg2="true" />
         <then>
            <move file ="${release_driver_dir}/C#" tofile="${release_driver_dir}/C#-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/C&amp;CPP" tofile="${release_driver_dir}/C&amp;CPP-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/Hadoop" tofile="${release_driver_dir}/Hadoop-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/Java" tofile="${release_driver_dir}/Java-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/PHP" tofile="${release_driver_dir}/PHP-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/Postgresql" tofile="${release_driver_dir}/Postgresql-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/Python" tofile="${release_driver_dir}/Python-${sequoiadb_version}-${platform}"/>
            <move file ="${release_driver_dir}/Spark" tofile="${release_driver_dir}/Spark-${sequoiadb_version}-${platform}"/>
            
            
            <tar destfile="${release_driver_dir}/C#-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="C#-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/C&amp;CPP-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="C&amp;CPP-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/Hadoop-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="Hadoop-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/Java-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="Java-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/PHP-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="PHP-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/Postgresql-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="Postgresql-${sequoiadb_version}-${platform}/**/*"/>
            <tar destfile="${release_driver_dir}/Python-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="Python-${sequoiadb_version}-${platform}/**/*"/>     
            <tar destfile="${release_driver_dir}/Spark-${sequoiadb_version}-${platform}.tar.gz" compression="gzip" longfile="gnu" 
                 basedir="${release_driver_dir}" includes="Spark-${sequoiadb_version}-${platform}/**/*"/>    
         </then>
      </if>
      
      
      

   </target>
   
   <target name="tar_commit_tool_package">
      <!-- ready php bin-->
      <delete dir="${srccode_dir}/tools/server/php" failonerror="false"/>
      <mkdir dir="${srccode_dir}/tools/server/php"/>
      <copy todir="${srccode_dir}/tools/server/php">
         <fileset dir="${srccode_dir}/tools/server/php_linux" includes="**/*"/>
      </copy>
      <!--conf,bin,jdk -->
      <tar destfile="${release_dir}/sequoiadb-commit-build-tools.tar.gz" 
           compression="gzip" longfile="gnu" basedir="${srccode_dir}" includes="conf/**/*,bin/**/*,java/jdk_linux64/**/*,tools/server/php/bin/**/*" />
   </target>
   
   <target name="copy_package_file" >
      <property name="release_db_dir" location="${release_dir}/sequoiadb" />
      <delete dir="${release_db_dir}" failonerror="false"/>
      <mkdir dir="${release_db_dir}"/>
      
      <mkdir dir="${release_db_dir}/CSharp" />
      <mkdir dir="${release_db_dir}/bin" />
      <mkdir dir="${release_db_dir}/conf/samples" />
      <mkdir dir="${release_db_dir}/conf/local" />
      <mkdir dir="${release_db_dir}/conf/log" />
      <mkdir dir="${release_db_dir}/conf/script" />
      <mkdir dir="${release_db_dir}/doc" />
      <mkdir dir="${release_db_dir}/hadoop" />
      <mkdir dir="${release_db_dir}/include" />
      <mkdir dir="${release_db_dir}/java/jdk" />
      <mkdir dir="${release_db_dir}/lib" />
      <mkdir dir="${release_db_dir}/license" />
      <mkdir dir="${release_db_dir}/packet" />
      <mkdir dir="${release_db_dir}/postgresql" />
      <mkdir dir="${release_db_dir}/python" />
      <mkdir dir="${release_db_dir}/samples" />
      <mkdir dir="${release_db_dir}/tools/server/php" />
      <mkdir dir="${release_db_dir}/tools/sequoias3"/>
      <mkdir dir="${release_db_dir}/web" />
      <mkdir dir="${release_db_dir}/www" />
      <mkdir dir="${release_db_dir}/spark" />
      <mkdir dir="${release_db_dir}/plugins" />
      <mkdir dir="${release_db_dir}/plugins/SequoiaSQL" />
      
      <copy file="${WORKSPACE}/archive/sequoiadb.dll" 
            tofile="${release_db_dir}/CSharp/sequoiadb.dll" />
              
      <copy todir="${release_db_dir}/bin" >
         <fileset dir="${srccode_dir}/bin" includes="**/*"/>
      </copy>
      <copy file="${srccode_dir}/script/sdbwsart" todir="${release_db_dir}/bin" />
      <replaceregexp file="${release_db_dir}/bin/sdbwsart" match="&#13;&#10;" replace="&#10;" flags="g" />
      <copy file="${srccode_dir}/script/sdbwstop" todir="${release_db_dir}/bin" />
      <replaceregexp file="${release_db_dir}/bin/sdbwstop" match="&#13;&#10;" replace="&#10;" flags="g" />

      
      <copy todir="${release_db_dir}/conf/script">
         <fileset dir="${srccode_dir}/conf/script" includes="**/*" />
      </copy>
      <copy todir="${release_db_dir}/conf/samples/">
         <fileset dir="${srccode_dir}/conf/samples/" />
      </copy>
      <copy file="${srccode_dir}/conf/sdbcm.conf" todir="${release_db_dir}/conf" />
      <copy file="${srccode_dir}/conf/limits.conf" todir="${release_db_dir}/conf" />
      
      <copy todir="${release_db_dir}/doc">
         <fileset dir="${srccode_dir}/../archive/" includes="*.pdf,*.chm,*.tar.gz"/>
      </copy>
      <copy todir="${release_db_dir}/doc/manual">
         <fileset dir="${srccode_dir}/doc/manual" />
      </copy>
      
      <copy todir="${release_db_dir}/hadoop" >
         <fileset dir="${srccode_dir}/driver/hadoop/hadoop-connector/build" includes="**/*" />
      </copy>
      <copy todir="${release_db_dir}/hadoop" >
         <fileset dir="${srccode_dir}/driver/hadoop/hive/build" includes="**/*" />
      </copy>
      
      <copy todir="${release_db_dir}/spark" >
         <fileset dir="${srccode_dir}/driver/spark/target" includes="*.jar" />
      </copy>
      
      <copy todir="${release_db_dir}/plugins/SequoiaSQL" >
         <fileset dir="${srccode_dir}/tools/om_plugins/sequoiasql" includes="**/*" excludes="source/**/*"/>
      </copy>
      
      <copy todir="${release_db_dir}/plugins/SequoiaSQL/bin" >
         <fileset dir="${srccode_dir}/tools/om_plugins/sequoiasql/source/target" includes="*.jar" />
      </copy>

      <copy todir="${release_db_dir}/tools/sequoias3" >
         <fileset dir="${srccode_dir}/SequoiaDB/engine/tools/sequoias3/target" includes="sequoia*.jar" />
      </copy>
      
      <copy todir="${release_db_dir}/tools/sequoias3" >
         <fileset dir="${srccode_dir}/SequoiaDB/engine/tools/sequoias3" includes="config/**/*,sequoias3.sh,README.txt" />
      </copy>
      
      <chmod file="${release_db_dir}/tools/sequoias3/sequoias3.sh" perm="u+x" />
      
      <delete dir="${release_db_dir}/plugins/SequoiaSQL/source" failonerror="false"/>
      
      <copy todir="${release_db_dir}/include">
         <fileset dir="${srccode_dir}/client/include" includes="**/*" />
      </copy>
      
      <for param="filepath">
         <path>
            <fileset dir="${srccode_dir}/driver/java/target">
               <include name="sequoiadb*.jar"/>
            </fileset>
         </path>
         <sequential>
            <var name="java_dir_path" value="@{filepath}"/>
         </sequential>
      </for>
      <copy file="${java_dir_path}" todir="${release_db_dir}/java" />
      <if>
         <equals arg1="${os.arch}" arg2="ppc64" />
         <then>
            <property name="php_version_arch" value="php_power" />
            <property name="jdk_arch" value="jdk_ppclinux64"/>
         </then>
      </if>
      <if>
         <equals arg1="Linux" arg2="${os.name}" />
         <then>
            <property name="jdk_arch" value="jdk_linux64"/>
            <property name="php_version_arch" value="php_linux" />
         </then>        
      </if>
      <copy todir="${release_db_dir}/java/jdk">
         <fileset dir="${srccode_dir}/java/${jdk_arch}/" />
      </copy>
      
      <copy todir="${release_db_dir}/lib">
         <fileset dir="${srccode_dir}/client/lib" includes="**/*" />
      </copy>
      <copy todir="${release_db_dir}/lib/phplib" >
         <fileset dir="${srccode_dir}/driver/php/release" includes="*.so" />
      </copy>

      <if>
         <equals arg1="${IS_ENTERPRISE}" arg2="true"/>
         <then>
            <copy file="${srccode_dir}/misc/ci/mkrelease/license/license_en.txt" tofile="${release_db_dir}/license/license_en.txt"/>
            <copy file="${srccode_dir}/misc/ci/mkrelease/license/license_zh.txt" tofile="${release_db_dir}/license/license_zh.txt"/>
         </then>
         <else>
            <copy file="${srccode_dir}/misc/ci/mkrelease/license/license_free_en.txt" tofile="${release_db_dir}/license/license_en.txt"/>
            <copy file="${srccode_dir}/misc/ci/mkrelease/license/license_free_zh.txt" tofile="${release_db_dir}/license/license_zh.txt"/>
         </else>
      </if>
      
      <copy todir="${release_db_dir}/postgresql" >
         <fileset dir="${srccode_dir}/driver/postgresql/build" includes="**/*" />
      </copy>     
      <chmod dir="${release_db_dir}/postgresql" includes="*sdb_fdw.so*" perm="a+x" />
      
      <copy todir="${release_db_dir}/python" >
         <fileset dir="${srccode_dir}/driver/python/" includes="pysequoiadb*py*.tar.gz" />
      </copy>
      
      <copy todir="${release_db_dir}/samples">
         <fileset dir="${srccode_dir}/client/samples" />
      </copy>
      
      <copy todir="${release_db_dir}/tools/sdbsupport">
         <fileset dir="${srccode_dir}/tools/sdbsupport" includes="**/*" />
      </copy>
      
      <copy todir="${release_db_dir}/tools">
         <fileset dir="${srccode_dir}/tools" includes="expect/**/*"/>
      </copy>
      <chmod file="${release_db_dir}/tools/expect/bin/expect" perm="u+x" />
      <chmod file="${release_db_dir}/tools/expect/trust/trustRelpConf.sh" perm="u+x" />
      <chmod file="${release_db_dir}/tools/sdbsupport/sdbsupport.sh" perm="u+x" />
      <copy todir="${release_db_dir}/tools/server/php">
         <fileset dir="${srccode_dir}/tools/server/${php_version_arch}/" />
      </copy>
      <copy todir="${release_db_dir}/tools/dr_ha">
         <fileset dir="${srccode_dir}/tools/dr_ha" includes="**/*" />
      </copy>
      
      <copy todir="${release_db_dir}/web" >
         <fileset dir="${srccode_dir}/SequoiaDB/web" includes="**/*"/>
      </copy>
      
      <copy todir="${release_db_dir}/www">
         <fileset dir="${srccode_dir}/client/admin/admintpl" />
      </copy>
      
      <!--single file-->
      <copy file="${srccode_dir}/script/sequoiadb"                todir="${release_db_dir}/" />  
      <copy file="${srccode_dir}/script/install_om.sh"            todir="${release_db_dir}/" />
      <copy file="${srccode_dir}/misc/ci/mkrelease/compatible.sh" todir="${release_db_dir}" />
      <copy file="${srccode_dir}/misc/ci/mkrelease/om_ver.conf"   todir="${release_db_dir}" />
      <copy file="${srccode_dir}/misc/ci/mkrelease/version.conf"  todir="${release_db_dir}" />
      <copy file="${srccode_dir}/misc/ci/mkrelease/sdbcm.service" todir="${release_db_dir}" />
      <replaceregexp file="${release_db_dir}/sequoiadb" match="&#13;&#10;" replace="&#10;" flags="g" />
          
      <!--exclude .svn-->
      <delete includeemptydirs="true">
         <fileset dir="${release_db_dir}" includes="**/.svn" />
      </delete>
   </target>   
      
   <target name="build_run_package" >
      <copy todir="${release_dir}">
         <fileset dir="${srccode_dir}/misc/ci/mkrelease" />
      </copy>      
   
      <if>
         <equals arg1="${IS_ENTERPRISE}" arg2="true" />
         <then>
            <property name="editon_str" value="-enterprise " />
         </then>
         <else>          
            <property name="editon_str" value="" />
         </else>
      </if>

      <var name="cmd" value="build sequoiadb_server.xml --setvars project.version=${sequoiadb_version} --setvars platform=${platform} --setvars enterpriseversion=${editon_str} --setvars project.outputDirectory=${release_dir}"/>
      <echo>exec cmd: builder ${cmd}</echo>
      <echo>exec in dir: ${release_dir}</echo>
      <exec executable="builder" dir="${release_dir}" failonerror="true" logError="true">
         <arg line="${cmd}" />
      </exec>
           
   </target>   
   
   <target name="build_tar_package">
      <if>
         <equals arg1="${TAR_PACKAGE}" arg2="true"/>
         <then>
            <if>
              <equals arg1="${IS_ENTERPRISE}" arg2="true" />
              <then>
                 <property name="enterprise_str" value="-enterprise" />
              </then>
              <else>          
                 <property name="enterprise_str" value="" />
              </else>
            </if>
            <tar destfile="${release_dir}/sequoiadb-${sequoiadb_version}-${platform}${enterprise_str}-installer.tar.gz" 
                 longfile="gnu" compression="gzip" 
                 basedir="${release_dir}" includes="sequoiadb-${sequoiadb_version}-${platform}*installer.run"/>
         </then>
      </if>
   </target>
   
   <target name="build_bin_package"> 
      <if>
        <equals arg1="${IS_ENTERPRISE}" arg2="true" />
        <then>
           <property name="enterprise_str" value="-enterprise" />
        </then>
        <else>          
           <property name="enterprise_str" value="" />
        </else>
      </if>
      <if>
         <equals arg1="${BIN_PACKAGE}" arg2="true" />
         <then>
         <tar destfile="${release_dir}/sequoiadb-${sequoiadb_version}-${platform}${enterprise_str}-bin.tar.gz" 
              compression="gzip" basedir="${release_dir}/sequoiadb/" includes="bin/**" />
         </then>
      </if>  
   </target>
   
   <target name="build_cov_package"> 
      <if>
         <equals arg1="${COVERAGE}" arg2="true" />
         <then>
            <tar destfile="${release_dir}/coverage_srccode.tar.gz" 
                 compression="gzip" 
                 basedir="${srccode_dir}" 
                 includes="SequoiaDB/engine/**/*,thirdparty/boost/boost/**/*,build/*/dd/**/*.gcno" />
            <echo file="${release_dir}/coverage.conf" message="source_code_dir=${srccode_dir}"/>
         </then>
      </if>
   </target>
   
   <macrodef name="dbversion">
      <attribute name="srccodedir"/>
      <attribute name="version"/>
      <sequential>
         <var name="tools_dir" value="@{srccodedir}/misc/ci/src/compile"/>
         <exec executable="gcc" dir="${tools_dir}" failonerror="true" logError="true">
            <arg line="${tools_dir}/print_version.c -o ${tools_dir}/print_version -I@{srccodedir}/SequoiaDB/engine/include" />
         </exec>
         <var name="@{version}" unset="true"/>
         <exec executable="${tools_dir}/print_version" outputproperty="@{version}" failonerror="true" logError="true" />
      </sequential>
   </macrodef>
   
   <macrodef name="svnversion">
      <attribute name="dir"/>
      <attribute name="version"/>
      <sequential>
         <var name="@{verison}" unset="true"/>
         <exec executable="bash" dir="@{dir}" outputproperty="@{version}" failonerror="true" logError="true" >
            <arg value="-c" />
            <arg line="&quot;svn info | grep Revision | awk '{print $2}'&quot;" />
         </exec>
      </sequential>
   </macrodef>
   
   <macrodef name="getplatform">
      <attribute name="resultProperty"/>
      <sequential>
         <exec executable="uname" outputproperty="uname" failonerror="true" logError="true" >
            <arg line="-i" />
         </exec>
         <var name="@{resultProperty}" value="unknown" unset="true"/>
         <condition property="@{resultProperty}" value="linux_x86_64">
            <equals arg1="${uname}" arg2="x86_64" />
         </condition>
         <condition property="@{resultProperty}" value="ppc_linux_64">
            <equals arg1="${uname}" arg2="ppc64" />
         </condition>
      </sequential>
   </macrodef>
 
</project>